# Nginx config for serving the React SPA + proxying API calls to Flask

server {
    listen 80;
    server_name _;

    # Where the built React files live inside the container
    root /usr/share/nginx/html;
    index index.html;

    # ── React SPA Routing ──────────────────────────────────────────
    # React Router handles URLs like /articles/5 entirely in the browser.
    # Without this, refreshing /articles/5 would make Nginx look for
    # a real file called /articles/5 → 404 error.
    # "try_files" says: look for the file, if not found → serve index.html
    # and let React Router handle it.
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ── API Proxy ──────────────────────────────────────────────────
    # Forward /api/* requests to the Flask backend container.
    # "backend" is the service name defined in docker-compose.yml —
    # Docker's internal DNS resolves it automatically.
    location /api/ {
        proxy_pass         http://backend:5000;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        # Allow larger bodies for image uploads (matches Flask's 5MB limit)
        client_max_body_size 6M;
    }

    # ── Image Uploads Proxy ────────────────────────────────────────
    # Proxy /uploads/* to Flask so images served by Flask are accessible
    location /uploads/ {
        proxy_pass         http://backend:5000;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        client_max_body_size 6M;
    }

    # ── Performance: Cache static assets ──────────────────────────
    # Vite builds assets with content hashes in filenames (e.g. index-abc123.js)
    # so they're safe to cache forever in the browser
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ── Security headers ───────────────────────────────────────────
    add_header X-Frame-Options       "SAMEORIGIN"   always;
    add_header X-Content-Type-Options "nosniff"      always;
    add_header X-XSS-Protection      "1; mode=block" always;
}
